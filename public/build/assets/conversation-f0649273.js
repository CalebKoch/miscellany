import{_ as m,k as b,o as a,c as i,a as r,t as c,b as u,h,e as p,d as k,F as x,r as y,f as w,g as _,q as C,v as M,j as v,l as B}from"./_plugin-vue_export-helper-c420bb3b.js";import{m as D}from"./mitt-f7ef348c.js";import{v as P}from"./v-click-outside.umd-d5c5f7b0.js";import"./_commonjsHelpers-725317a4.js";const F={directives:{clickOutside:P.directive},props:["message","trans"],data(){return{openedDropdown:!1}},computed:{isUser:function(){return this.message.user!==null},isCharacter:function(){return this.message.character!==null}},methods:{deleteMessage:function(e){this.emitter.emit("delete_message",e)},editMessage:function(e){this.emitter.emit("edit_message",e)},translate(e){return this.trans[e]??"unknown"},dropdownClass(){return this.openedDropdown?"open dropdown relative":"dropdown relative"},openDropdown(){return this.openedDropdown=!0},boxClasses:function(e){let s="box-comment bg-base-200 px-1 py-3 flex flex-col gap-1";return s+=" message-author-"+e.from_id,s+=" message-real-author-"+e.created_by,e.group?s+=" message-followup":s+=" message-first mt-2",s},onClickOutside(e){this.openedDropdown=!1}}},T={key:0,class:"flex items-center gap-1"},j={class:"message-author"},V={key:0,class:"user"},N={key:1,class:"character"},O={key:2,class:"unknown"},z={class:"grow"},H={key:0,class:"text-xs text-neutral-content"},U={key:0,class:"message-options mr-1"},I=r("span",{class:"caret"},null,-1),S=[I],E={class:"dropdown-menu dropdown-menu-right",role:"menu"},K={class:"comment-text"},q=["title"];function A(e,s,t,g,o,n){const d=b("click-outside");return a(),i("div",{class:p(n.boxClasses(t.message))},[t.message.group?u("",!0):(a(),i("div",T,[r("div",j,[n.isUser?(a(),i("strong",V,c(t.message.user),1)):n.isCharacter?(a(),i("strong",N,[r("span",null,c(t.message.character),1)])):(a(),i("strong",O,c(n.translate("user_unknown")),1))]),r("div",z,[t.message.group?u("",!0):(a(),i("span",H,c(t.message.created_at),1))]),t.message.can_delete?(a(),i("div",U,[h((a(),i("div",{class:p(n.dropdownClass())},[r("a",{onClick:s[0]||(s[0]=l=>n.openDropdown()),role:"button"},S),r("ul",E,[r("li",null,[r("a",{role:"button",onClick:s[1]||(s[1]=l=>n.editMessage(t.message))},c(n.translate("edit")),1)]),r("li",null,[r("a",{role:"button",onClick:s[2]||(s[2]=l=>n.deleteMessage(t.message))},c(n.translate("remove")),1)])])],2)),[[d,n.onClickOutside]])])):u("",!0)])),r("div",K,[k(c(t.message.message)+" ",1),t.message.is_updated?(a(),i("span",{key:0,class:"text-xs text-neutral-content italic",title:t.message.updated_at},c(n.translate("is_updated")),9,q)):u("",!0)])],2)}const J=m(F,[["render",A]]),L={props:["api","trans"],components:{Message:J},data(){return{messages:[],sending:!1,scrolledToBottom:!1,chatBox:null,newsest:null,previous:!1,loadingPrevious:!1,initializing:!0}},methods:{getMessages:function(){axios.get(this.api,{params:{newest:this.newest}}).then(e=>{this.sending=!1,this.messages.push(...e.data.data.messages),this.previous=e.data.data.previous,this.initializing=!1,this.scrollToBottom()})},scrollToBottom:function(){setTimeout(()=>{let e=this.$refs.messagebox;e.scrollTop=e.scrollHeight},50),this.messages.length>0?this.newest=this.messages[this.messages.length-1].id:this.newest=void 0},getPrevious:function(){this.loadingPrevious=!0,axios.get(this.api,{params:{oldest:this.messages[0].id}}).then(e=>{this.messages.unshift(...e.data.data.messages),this.previous=e.data.data.previous,this.loadingPrevious=!1})},deleteMessage:function(e){axios.delete(e.delete_url).then(()=>{let s=this.messages.findIndex(t=>t.id===e.id);this.messages.splice(s,1)})},translate(e){return this.trans[e]??"unknown"}},mounted(){this.getMessages(),this.emitter.on("sending_message",()=>{this.sending=!0}),this.emitter.on("sent_message",()=>{this.getMessages()}),this.emitter.on("edited_message",e=>{let s=this.messages.findIndex(t=>t.id===e.id);this.messages[s]=e}),this.emitter.on("delete_message",(e,s)=>{this.deleteMessage(e,s)})}},G={class:"box-comments overflow-auto",ref:"messagebox"},Q={key:1,class:"load-more cursor-pointer text-center my-5"},R=r("i",{class:"fa-solid fa-spin fa-spinner"},null,-1),W=[R],X={key:2,class:"load-more cursor-pointer text-center my-5"},Y=r("i",{class:"fa-solid fa-spin fa-spinner fa-4x"},null,-1),Z=[Y],$={key:3,class:"text-center"},ee=r("i",{class:"fa-solid fa-spin fa-spinner"},null,-1),se=[ee];function te(e,s,t,g,o,n){const d=_("Message");return a(),i("div",G,[o.previous&&!o.loadingPrevious?(a(),i("div",{key:0,class:"load-more cursor-pointer text-center my-5",onClick:s[0]||(s[0]=(...l)=>n.getPrevious&&n.getPrevious(...l))},c(n.translate("load_previous")),1)):u("",!0),o.loadingPrevious?(a(),i("div",Q,W)):u("",!0),o.initializing?(a(),i("div",X,Z)):u("",!0),(a(!0),i(x,null,y(o.messages,l=>(a(),w(d,{key:l.id,message:l,trans:t.trans},null,8,["message","trans"]))),128)),o.sending?(a(),i("div",$,se)):u("",!0)],512)}const ne=m(L,[["render",te]]),ae={props:{target:void 0,api:void 0,targets:void 0,disabled:{type:Boolean},trans:void 0},data(){return{body:null,sending:!1,character_id:null,message_id:null,edit_message:null}},methods:{typing(e){e.keyCode===13&&!e.shiftKey&&(e.preventDefault(),this.sendMessage())},editMessage(e){this.message_id=e.id,this.edit_message=e,this.body=e.message,document.getElementById("message").focus()},sendMessage(){if(!(!this.body||this.body.trim()==="")&&!(this.targetCharacter&&this.character_id===null)){this.sending=!0,this.emitter.emit("sending_message");var e=this.api,s={message:this.body.trim()};this.targetCharacter&&(s.character_id=this.character_id),this.message_id?(e+="/"+this.message_id,axios.put(e,s).then(t=>{this.emitter.emit("edited_message",t.data.data),this.messageHandler()}).catch(()=>{this.sending=!1})):axios.post(e,s).then(()=>{this.messageHandler()}).catch(()=>{this.sending=!1})}},messageHandler(){this.sending=!1,this.body=null,this.message_id=null,this.emitter.emit("sent_message")},translate(e){return this.json_trans[e]??"unknown"}},computed:{targetCharacter:function(){return this.target==="character"},inputFormDisabled:function(){return this.sending},commentable:function(){return this.targetCharacter?this.targets!==null:!0}},mounted(){this.emitter.on("edit_message",(e,s)=>{this.editMessage(e,s)})}},ie={key:0,class:"box-footer mt-5"},re={class:"flex items-center gap-2"},oe={key:0,class:"max-w-xs"},de=["value"],le={class:"field grow"},ce=["placeholder","disabled"];function ue(e,s,t,g,o,n){return n.commentable?(a(),i("div",ie,[r("div",re,[n.targetCharacter?(a(),i("div",oe,[h(r("select",{class:"form-control","onUpdate:modelValue":s[0]||(s[0]=d=>o.character_id=d)},[(a(!0),i(x,null,y(t.targets,(d,l)=>(a(),i("option",{value:l,key:l},c(d),9,de))),128))],512),[[C,o.character_id]])])):u("",!0),r("div",le,[h(r("input",{type:"text",id:"message",maxlength:"1000",autocomplete:"off",class:"w-full",onKeydown:s[1]||(s[1]=(...d)=>n.typing&&n.typing(...d)),"onUpdate:modelValue":s[2]||(s[2]=d=>o.body=d),placeholder:t.disabled?n.translate("is_closed"):"",disabled:n.inputFormDisabled||t.disabled},null,40,ce),[[M,o.body]])])])])):u("",!0)}const me=m(ae,[["render",ue]]),ge={props:{id:void 0,send:void 0,target:void 0,api:void 0,targets:void 0,trans:void 0,disabled:{type:Boolean}},components:{Form:me,Messages:ne},data(){return{json_trans:[]}},mounted(){this.json_trans=JSON.parse(this.trans)}},he={class:"viewport box-conversation"};function _e(e,s,t,g,o,n){const d=_("Messages"),l=_("Form");return a(),i("div",he,[v(d,{api:t.api,trans:o.json_trans},null,8,["api","trans"]),v(l,{api:t.send,target:t.target,targets:t.targets,disabled:t.disabled,trans:o.json_trans},null,8,["api","target","targets","disabled","trans"])])}const fe=m(ge,[["render",_e]]),pe=D(),f=B({});f.config.globalProperties.emitter=pe;f.component("conversation",fe);f.mount("#conversation");
