import{_ as m,k,o as i,c as a,a as r,h,e as _,t as c,b as u,d as v,F as x,r as b,f as w,g as f,q as C,v as M,j as y,l as B}from"./_plugin-vue_export-helper-de6cf830.js";import{m as D}from"./mitt-f7ef348c.js";import{v as F}from"./v-click-outside.umd-d5c5f7b0.js";import"./_commonjsHelpers-725317a4.js";const P={directives:{clickOutside:F.directive},props:["message","trans"],data(){return{openedDropdown:!1}},computed:{isUser:function(){return this.message.user!==null},isCharacter:function(){return this.message.character!==null}},methods:{deleteMessage:function(e){this.emitter.emit("delete_message",e)},editMessage:function(e){this.emitter.emit("edit_message",e)},translate(e){return this.trans[e]??"unknown"},dropdownClass(){return this.openedDropdown?"open dropdown relative":"dropdown relative"},openDropdown(){return this.openedDropdown=!0},boxClasses:function(e){let s="box-comment px-1 py-3";return s+=" message-author-"+e.from_id,s+=" message-real-author-"+e.created_by,e.group?s+=" message-followup":s+=" message-first mt-2",s},onClickOutside(e){this.openedDropdown=!1}}},T={class:"message-time text-right pull-right"},j={key:0,class:"message-options mr-2"},V=r("span",{class:"caret"},null,-1),N=[V],O={class:"dropdown-menu dropdown-menu-right",role:"menu"},z={key:0,class:"message-author"},H={key:0,class:"user"},U={key:1,class:"character"},I={key:2,class:"unknown"},S={class:"comment-text ml-0"},E={key:0,class:"pull-right text-muted"},K=["title"];function q(e,s,t,g,o,n){const d=k("click-outside");return i(),a("div",{class:_(n.boxClasses(t.message))},[r("div",T,[t.message.can_delete?(i(),a("div",j,[h((i(),a("div",{class:_(n.dropdownClass())},[r("a",{onClick:s[0]||(s[0]=l=>n.openDropdown()),role:"button"},N),r("ul",O,[r("li",null,[r("a",{role:"button",onClick:s[1]||(s[1]=l=>n.editMessage(t.message))},c(n.translate("edit")),1)]),r("li",null,[r("a",{role:"button",onClick:s[2]||(s[2]=l=>n.deleteMessage(t.message))},c(n.translate("remove")),1)])])],2)),[[d,n.onClickOutside]])])):u("",!0)]),t.message.group?u("",!0):(i(),a("div",z,[n.isUser?(i(),a("strong",H,c(t.message.user),1)):n.isCharacter?(i(),a("strong",U,[r("span",null,c(t.message.character),1)])):(i(),a("strong",I,c(n.translate("user_unknown")),1))])),r("div",S,[v(c(t.message.message)+" ",1),t.message.group?u("",!0):(i(),a("span",E,[t.message.is_updated?(i(),a("em",{key:0,title:t.message.updated_at},c(n.translate("is_updated"))+",",9,K)):u("",!0),v(" "+c(t.message.created_at),1)]))])],2)}const A=m(P,[["render",q]]),J={props:["api","trans"],components:{Message:A},data(){return{messages:[],sending:!1,scrolledToBottom:!1,chatBox:null,newsest:null,previous:!1,loadingPrevious:!1,initializing:!0}},methods:{getMessages:function(){axios.get(this.api,{params:{newest:this.newest}}).then(e=>{this.sending=!1,this.messages.push(...e.data.data.messages),this.previous=e.data.data.previous,this.initializing=!1,this.scrollToBottom()})},scrollToBottom:function(){setTimeout(()=>{let e=this.$refs.messagebox;e.scrollTop=e.scrollHeight},50),this.messages.length>0?this.newest=this.messages[this.messages.length-1].id:this.newest=void 0},getPrevious:function(){this.loadingPrevious=!0,axios.get(this.api,{params:{oldest:this.messages[0].id}}).then(e=>{this.messages.unshift(...e.data.data.messages),this.previous=e.data.data.previous,this.loadingPrevious=!1})},deleteMessage:function(e){axios.delete(e.delete_url).then(()=>{let s=this.messages.findIndex(t=>t.id===e.id);this.messages.splice(s,1)})},translate(e){return this.trans[e]??"unknown"}},mounted(){this.getMessages(),this.emitter.on("sending_message",()=>{this.sending=!0}),this.emitter.on("sent_message",()=>{this.getMessages()}),this.emitter.on("edited_message",e=>{let s=this.messages.findIndex(t=>t.id===e.id);this.messages[s]=e}),this.emitter.on("delete_message",(e,s)=>{this.deleteMessage(e,s)})}},L={class:"box-comments overflow-auto",ref:"messagebox"},G={key:1,class:"load-more cursor-pointer text-center my-5"},Q=r("i",{class:"fa-solid fa-spin fa-spinner"},null,-1),R=[Q],W={key:2,class:"load-more cursor-pointer text-center my-5"},X=r("i",{class:"fa-solid fa-spin fa-spinner fa-4x"},null,-1),Y=[X],Z={key:3,class:"text-center"},$=r("i",{class:"fa-solid fa-spin fa-spinner"},null,-1),ee=[$];function se(e,s,t,g,o,n){const d=f("Message");return i(),a("div",L,[o.previous&&!o.loadingPrevious?(i(),a("div",{key:0,class:"load-more cursor-pointer text-center my-5",onClick:s[0]||(s[0]=(...l)=>n.getPrevious&&n.getPrevious(...l))},c(n.translate("load_previous")),1)):u("",!0),o.loadingPrevious?(i(),a("div",G,R)):u("",!0),o.initializing?(i(),a("div",W,Y)):u("",!0),(i(!0),a(x,null,b(o.messages,l=>(i(),w(d,{key:l.id,message:l,trans:t.trans},null,8,["message","trans"]))),128)),o.sending?(i(),a("div",Z,ee)):u("",!0)],512)}const te=m(J,[["render",se]]),ne={props:{target:void 0,api:void 0,targets:void 0,disabled:{type:Boolean},trans:void 0},data(){return{body:null,sending:!1,character_id:null,message_id:null,edit_message:null}},methods:{typing(e){e.keyCode===13&&!e.shiftKey&&(e.preventDefault(),this.sendMessage())},editMessage(e){this.message_id=e.id,this.edit_message=e,this.body=e.message,document.getElementById("message").focus()},sendMessage(){if(!(!this.body||this.body.trim()==="")&&!(this.targetCharacter&&this.character_id===null)){this.sending=!0,this.emitter.emit("sending_message");var e=this.api,s={message:this.body.trim()};this.targetCharacter&&(s.character_id=this.character_id),this.message_id?(e+="/"+this.message_id,axios.put(e,s).then(t=>{this.emitter.emit("edited_message",t.data.data),this.messageHandler()}).catch(()=>{this.sending=!1})):axios.post(e,s).then(()=>{this.messageHandler()}).catch(()=>{this.sending=!1})}},messageHandler(){this.sending=!1,this.body=null,this.message_id=null,this.emitter.emit("sent_message")},translate(e){return this.json_trans[e]??"unknown"}},computed:{targetCharacter:function(){return this.target==="character"},inputForm:function(){return this.targetCharacter?"col-md-9":"col-md-12"},inputFormDisabled:function(){return this.sending},commentable:function(){return this.targetCharacter?this.targets!==null:!0}},mounted(){this.emitter.on("edit_message",(e,s)=>{this.editMessage(e,s)})}},ie={key:0,class:"box-footer"},ae={class:"row"},re={key:0,class:"col-md-3"},oe=["value"],de=["placeholder","disabled"];function le(e,s,t,g,o,n){return n.commentable?(i(),a("div",ie,[r("div",ae,[n.targetCharacter?(i(),a("div",re,[h(r("select",{class:"form-control","onUpdate:modelValue":s[0]||(s[0]=d=>o.character_id=d)},[(i(!0),a(x,null,b(t.targets,(d,l)=>(i(),a("option",{value:l,key:l},c(d),9,oe))),128))],512),[[C,o.character_id]])])):u("",!0),r("div",{class:_(n.inputForm)},[h(r("input",{type:"text",id:"message",maxlength:"1000",autocomplete:"off",class:"form-control",onKeydown:s[1]||(s[1]=(...d)=>n.typing&&n.typing(...d)),"onUpdate:modelValue":s[2]||(s[2]=d=>o.body=d),placeholder:t.disabled?n.translate("is_closed"):"",disabled:n.inputFormDisabled||t.disabled},null,40,de),[[M,o.body]])],2)])])):u("",!0)}const ce=m(ne,[["render",le]]),ue={props:{id:void 0,send:void 0,target:void 0,api:void 0,targets:void 0,trans:void 0,disabled:{type:Boolean}},components:{Form:ce,Messages:te},data(){return{json_trans:[]}},mounted(){this.json_trans=JSON.parse(this.trans)}},me={class:"viewport box-conversation"};function ge(e,s,t,g,o,n){const d=f("Messages"),l=f("Form");return i(),a("div",me,[y(d,{api:t.api,trans:o.json_trans},null,8,["api","trans"]),y(l,{api:t.send,target:t.target,targets:t.targets,disabled:t.disabled,trans:o.json_trans},null,8,["api","target","targets","disabled","trans"])])}const he=m(ue,[["render",ge]]),_e=D(),p=B({});p.config.globalProperties.emitter=_e;p.component("conversation",he);p.mount("#conversation");
